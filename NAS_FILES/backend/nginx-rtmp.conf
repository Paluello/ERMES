# Configurazione nginx-rtmp per ricevere stream RTMP da app iOS
# Versione semplificata per Docker

events {
    worker_connections 1024;
}

rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        application stream {
            live on;
            
            # Consenti pubblicazione da qualsiasi IP
            allow publish all;
            deny play all;  # Solo push, non pull
            
            # Notify quando stream inizia/termina (per monitoraggio e debugging)
            on_publish http://ermes-backend:8000/api/rtmp/on_publish;
            on_publish_done http://ermes-backend:8000/api/rtmp/on_publish_done;
        }
    }
}

# HTTP server minimo per statistiche RTMP
http {
    server {
        listen 80;
        
        # Endpoint per status RTMP
        location /rtmp_status {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            access_log off;
        }
        
        # Serve stat.xsl per visualizzazione statistiche
        location /stat.xsl {
            root /usr/local/nginx/html;
        }
    }
}


# Docker Compose GitHub per NAS (ottimizzato ARM)
# Nota: 'version' Ã¨ obsoleto nelle versioni moderne di Docker Compose

services:
  ermes-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.github.nas
      args:
        GITHUB_REPO: ${GITHUB_REPO:-Paluello/ERMES}
        GITHUB_BRANCH: ${GITHUB_BRANCH:-main}
        GITHUB_TOKEN: ${GITHUB_TOKEN:-}
    container_name: ermes-backend
    ports:
      - "8000:8000"
    volumes:
      - ermes-models:/app/backend/models
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./backend/update_container.sh:/app/update_container.sh:ro
      - .:/workspace:rw  # Monta la directory corrente (read-write per git pull)
      - ./backend/app:/app/backend/app:ro  # Monta il codice Python per hot-reload (solo restart necessario)
    environment:
      - UPDATE_SCRIPT_PATH=/app/update_container.sh
      - PROJECT_DIR=/workspace
      - COMPOSE_FILE=docker-compose.github.nas.yml
      - GITHUB_REPO=${GITHUB_REPO:-Paluello/ERMES}
      - GITHUB_BRANCH=${GITHUB_BRANCH:-main}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_AUTO_UPDATE_ENABLED=${GITHUB_AUTO_UPDATE_ENABLED:-true}
      - GITHUB_AUTO_UPDATE_INTERVAL_MINUTES=${GITHUB_AUTO_UPDATE_INTERVAL_MINUTES:-5}
      - GPS_PRECISION=standard
      - YOLO_MODEL=yolov8n.pt
      - YOLO_CONF_THRESHOLD=0.6
      - MAX_TRACKED_OBJECTS=10
      - VIDEO_FPS=15
      - API_HOST=0.0.0.0
      - API_PORT=8000
    restart: unless-stopped
    networks:
      - ermes-network
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G

  nginx-rtmp:
    image: tiangolo/nginx-rtmp:latest
    container_name: ermes-rtmp
    ports:
      - "1935:1935"
    volumes:
      - ./backend/nginx-rtmp.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped
    networks:
      - ermes-network
    depends_on:
      - ermes-backend

volumes:
  ermes-models:

networks:
  ermes-network:
    driver: bridge

